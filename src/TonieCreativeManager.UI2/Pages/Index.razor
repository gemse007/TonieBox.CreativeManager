@page "/"
@page "/{household}"
@inject TonieCloudService _TonieCloudService
@inject NavigationManager _NavigationManager
@inject IEnumerable<PersistentData.User> Users
@inject PersistentData.User SelectedUser
@inject ISnackbar _Snackbar

<PageTitle>Welcome to the world of Tonie</PageTitle>
<MudCard Class="ma-sx-1 ma-lg-16" Elevation="5">
    <MudCardHeader>
        <MudText Typo="Typo.h4">Hello @SelectedUser?.Name!</MudText>
    </MudCardHeader>
</MudCard>

@code {
    [Parameter] public string? household { get; set; }

    protected override async void OnAfterRender(bool firstRender)
    {
        if (Users == null || Users.Count() == 0)
        {
            _NavigationManager.NavigateTo("/settings", true);
            return;
        }
        else
        {
            bool loggedin = false;
            try
            {
                var households = await _TonieCloudService.GetHouseholds();
                loggedin = households?.Count() > 0;
                var householdId = households?.Count() == 1 ? households.First().Id : string.IsNullOrEmpty(household) ? SelectedUser?.HouseholdId : household;
                var h = households?.FirstOrDefault(_ => _.Id == householdId);
                if (h != null)
                    _NavigationManager.NavigateTo((SelectedUser?.Id ?? 0) == 0 || SelectedUser?.HouseholdId != household ? $"/userselect/{householdId}" : "/media", true);
                else
                    _Snackbar.Add("Please Provide HouseHoldID!");
            }
            catch { }
            if (!loggedin)
            {
                _Snackbar.Add("Login to MyTonieCloud didn't work -> check your credentials!");
                //_NavigationManager.NavigateTo("/settings", true);
            }
            return;
        }
    }
}